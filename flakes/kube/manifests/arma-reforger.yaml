---
apiVersion: onepassword.com/v1
kind: OnePasswordItem
metadata:
  name: "arma-reforger"
  namespace: gaming
spec:
  itemPath: "vaults/Kubernetes/items/bo7ij7tziueojgebxbpvuov55e"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: arma-mods
  namespace: gaming
data:
  mods.json: |
    [
      {
        "modId": "66FCED586CC278D5" // brotherhood survival
      },
      {
        "modId": "5CAB06A845A6DC18" // units map markers
      }
    ]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose -f docker-compose.yml convert
    kompose.version: 1.35.0 (HEAD)
  labels:
    io.kompose.service: arma-reforger
  name: arma-reforger
  namespace: gaming
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: arma-reforger
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        kompose.cmd: kompose -f docker-compose.yml convert
        kompose.version: 1.35.0 (HEAD)
      labels:
        io.kompose.service: arma-reforger
    spec:
      nodeSelector:
        kubernetes.io/hostname: homelab
      containers:
        - image: ghcr.io/acemod/arma-reforger:latest
          workingDir: /reforger
          name: arma-reforger
          command: ["/bin/bash", "-c"]
          args: # remove comments from mods.json
            - rm -f /reforger/Configs/docker_generated.json && cat /config/mods.json | sed -re 's#^(([^"\n]*"[^"\n]*")*[^"\n]*)\/\/.*$#\1#' > /mods.json && python3 /launch.py
          env:
            - name: GAME_NAME
              value: heywoodlh-arma
            - name: GAME_ADMINS
              value: "76561198268733886"
            - name: GAME_SCENARIO_ID
              value: "{3E1C5811E6614663}Missions/testworld.conf"
            - name: GAME_PROPS_BATTLEYE
              value: "false"
            - name: GAME_SUPPORTED_PLATFORMS
              value: "PLATFORM_PC,PLATFORM_XBL,PLATFORM_PSN"
            - name: SERVER_PUBLIC_ADDRESS
              value: "100.77.128.95"
            - name: GAME_PASSWORD_ADMIN
              valueFrom:
                secretKeyRef:
                  key: password
                  name: arma-reforger
            - name: RCON_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: rcon
                  name: arma-reforger
            - name: GAME_MODS_JSON_FILE_PATH
              value: "/mods.json"
          ports:
            - containerPort: 2001
              protocol: UDP
            - containerPort: 17777
              protocol: UDP
            - containerPort: 19999
              protocol: UDP
          volumeMounts:
            - mountPath: /reforger/Configs
              name: configs
            - mountPath: /home/profile
              name: home-profile
            - mountPath: /root
              name: root
            - mountPath: /reforger/workshop
              name: workshop
            - name: arma-mods
              mountPath: /config/mods.json
              subPath: mods.json
      restartPolicy: Always
      volumes:
        - name: configs
          hostPath:
            path: /media/data-ssd/games/arma-reforger/configs
        - name: home-profile
          hostPath:
            path: /media/data-ssd/games/arma-reforger/home-profile
        - name: root
          hostPath:
            path: /media/data-ssd/games/arma-reforger/root
        - name: workshop
          hostPath:
            path: /media/data-ssd/games/arma-reforger/workshop
        - name: arma-mods
          configMap:
            name: arma-mods
            items:
            - key: mods.json
              path: mods.json
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: kompose -f docker-compose.yml convert
    kompose.version: 1.35.0 (HEAD)
    tailscale.com/tags: "tag:arma-reforger"
    tailscale.com/hostname: "arma-reforger"
    tailscale.com/expose: "true"
  labels:
    io.kompose.service: arma-reforger
  name: arma-reforger
  namespace: gaming
spec:
  ports:
    - name: "udp"
      port: 2001
      protocol: UDP
      targetPort: 2001
    - name: "udp1"
      port: 17777
      protocol: UDP
      targetPort: 17777
    - name: "rcon"
      port: 19999
      protocol: UDP
      targetPort: 19999
  selector:
    io.kompose.service: arma-reforger
